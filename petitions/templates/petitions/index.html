{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container text-center mt-5">
    <h1>Petitions</h1>
    <button class="btn btn-primary btn-lg" id="createBtn">
        <i class="fa fa-plus"></i> Create Petition
    </button>
</div>

<!-- Modal Popup -->
<div id="petitionModal" class="modal" tabindex="-1" style="display:none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create Petition</h2>
                <button type="button" class="btn-close" id="closeModal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="petitionForm" method="post" action="{% url 'petitions.index' %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="name" class="form-label">Your Name</label>
                        <input type="text" id="name" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea id="description" name="description" class="form-control" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fa fa-paper-plane"></i> Submit Petition
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* Custom modal backdrop */
#petitionModal {
    display: none;
    background: rgba(0,0,0,0.5);
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    z-index: 1050;
}
#petitionModal.d-block {
    display: block;
}
.petition-card {
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    background: #fff;
    text-align: left;
}
.petition-like-btn {
    border: none;
    background: none;
    color: #0d6efd;
    font-size: 1.2rem;
    cursor: pointer;
}
.petition-like-btn.liked {
    color: #198754;
}
</style>

<div class="container mt-4">
    <div class="row justify-content-center">
        {% for petition in petitions %}
        <div class="col-md-6">
            <div class="petition-card">
                <h5>{{ petition.name }}</h5>
                <p>{{ petition.description }}</p>
                <div>
                    {% if user.is_authenticated %}
                        {% if petition.id in liked_petition_ids %}
                        <button class="petition-like-btn liked" data-id="{{ petition.id }}" disabled>
                            <i class="fa fa-thumbs-up"></i>
                            <span class="upvote-count">{{ petition.upvotes }}</span>
                        </button>
                        {% else %}
                        <button class="petition-like-btn" data-id="{{ petition.id }}">
                            <i class="fa fa-thumbs-up"></i>
                            <span class="upvote-count">{{ petition.upvotes }}</span>
                        </button>
                        {% endif %}
                    {% else %}
                        <span class="text-muted">Login to like</span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <p>No petitions yet.</p>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    const createBtn = document.getElementById('createBtn');
    const modal = document.getElementById('petitionModal');
    const closeModal = document.getElementById('closeModal');
    const petitionForm = document.getElementById('petitionForm');

    createBtn.onclick = () => {
        modal.classList.add('d-block');
    };
    closeModal.onclick = () => {
        modal.classList.remove('d-block');
    };
    window.onclick = (event) => {
        if (event.target === modal) {
            modal.classList.remove('d-block');
        }
    };

    // Like button AJAX
    document.querySelectorAll('.petition-like-btn').forEach(btn => {
        btn.onclick = function() {
            if (btn.disabled) return;
            const petitionId = this.getAttribute('data-id');
            fetch("{% url 'petitions.like' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: "petition_id=" + petitionId
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.querySelector('.upvote-count').textContent = data.upvotes;
                    this.classList.add('liked');
                    this.disabled = true;
                } else if (data.error) {
                    alert(data.error);
                }
            });
        };
    });
</script>
{% endblock %}
